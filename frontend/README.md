# フロントエンド構成

## 概要

このプロジェクトは React(TypeScript) を使用したフロントエンドアプリケーションです。

## 技術スタック

- Node.js(v22.22.0 (LTS))
- TypeScript

### 主要ライブラリ

| カテゴリ         | ライブラリ                                             | 用途                                                                           |
| ---------------- | ------------------------------------------------------ | ------------------------------------------------------------------------------ |
| **ルーティング** | React Router (`react-router-dom`)                      | ページ遷移の管理                                                               |
| **状態管理**     | `useState` / `useContext` / `useMemo` / TanStack Query | ローカル状態、グローバル状態（パスワード変更促進フラグなど）、サーバー状態管理 |
| **フォーム**     | React Hook Form + Zod                                  | フォーム制御とバリデーション(sharedにスキーマ定義)                             |
| **スタイル**     | Tailwind CSS                                           | ユーティリティファーストCSS                                                    |
| **デザイン**     | Figma                                                  | UI・Layoutのデザイン開発                                                       |
| **テスト**       | Vitest / Playwright                                    | ユニットテスト / E2Eテスト                                                     |
| **UIカタログ**   | Storybook                                              | コンポーネントの可視化・管理                                                   |
| **フォーマッタ** | Prettier                                               | セミコロンやクオーテーションなど簡単なルールのみ                               |
| **リンター**     | ESLint 　　　                                          | recommended程度                                                                |

### 状態管理の使い分け

- **useState**: コンポーネント内のローカル状態(基本的にReact Hook Formが行う)
- **useContext**: パスワード変更促進フラグ、ログインユーザーのロール管理(複数画面・UI制御)
- **useMemo**: 取得したマスタデータのマッピングや、ラジオボタングループやチェックボックスグループの配置をMemo化(その都度処理をしない)
- **TanStack Query**: マスタデータの取得、データ操作（CRUD）

## ディレクトリ構成

```
src/
├─ api/
│  └─ # axios等の設定、共通インターセプター（トークン注入・共通エラー処理）
│
├─ assets/
│  └─ # 画像、SVG静的リソース
│
├─ components/
│  ├─ Guard/
│  │  └─ # PageGuard: 権限（Role）や認証状態に基づいたレンダリング制御
│  ├─ UI/
│  │  └─ # Button, Input等、ドメイン知識を持たない汎用部品（Storybook）
│  └─ Layouts/
│     └─ # Header, Error等、画面の骨組み（Storybook）
│
├─ contexts/
│  └─ # AuthContext, ThemeContext 等、グローバルに共有する状態
│
├─ features/
│  └─ [feature-name]/
│     ├─ pages/
│     │  └─ # 機能のルートとなる画面（ロジックのオーケストレーション）
│     ├─ components/
│     │  └─ # その機能でしか使わない複雑なフォームやリスト部品
│     ├─ api/
│     │  └─ # エンドポイント定義、リクエスト/レスポンスの型定義
│     ├─ hooks/
│     │  └─ # useMutation, useQuery をラップした、UIから分離されたロジック
│     └─ constants/
│        └─ # ラベル定義
│
├─ pages/
│  └─ # Home, NotFound, ServerError 等、機能に依存しない共通画面
│
├─ routes/
│  └─ # ROUTES定数、BrowserRouterの設定、動的ルートの定義
│
├─ utils/
│  ├─ # handleApiError: APIエラーをトーストや遷移に変換する共通処理
│  ├─ # authErrorGenerate: エラーメッセージの文言生成ロジック（(フロントのみで完結)
│  ├─ # downloadBlob: ファイルダウンロードのヘルパー
│
├─ App.tsx    # プロバイダーの設置、PageGuardによる全体ルーティング
├─ index.css  # Tailwind等のグローバルスタイル
└─ main.tsx   # ReactのMount、StrictMode設定
```

## 設計方針

### API通信

- `api/` ディレクトリの汎用関数を使用
- 各featuresでAPIパス、HTTPメソッド、リクエストボディを指定して使用
- CSRF トークンと JWT は自動で付与
- レスポンスが不正な時も、対応できる(サーバーに繋がらない時やJSONが壊れた時など)
- **制限事項**: JSON形式レスポンスのみ対応（ZIPファイル等のバイナリダウンロードは非対応）

### Components

- `UI・Layout`のデザインは`Figma`を用いて開発
- Propsを用いて、型安全に
- hooks formを用いるので、`forwardRef`を使用して、親が直接操作できるように
- `label と id`、`fieldset と legend` といった基本的なセマンティクスを守る
- `ARIA属性`を適切に実装
- カタログとして見れるように`Storybook`を使用
- `Guard`は`App.tsx`内で、UX単位の画面制限(下記のContext参照)

### Context

#### **auth**

- 本プロジェクトでは、管理者・学生で利用可能なAPI／画面を分離しており、学生は学生作成などの操作は不可としている。
- ただし画面表示自体はAPIを伴わず可能なため、権限のないユーザーでも到達できる可能性がある。
- そのためUX向上のため、ログインユーザー情報をコンテキストで管理し、権限に応じて画面遷移を制御している。

#### **passwordUpdate**

- ログイン時に、学生が初期パスワードのまま、もしくは変更から30日以上経過していた場合は、パスワード変更ボタンの横に!マークが出現する
- auth同様、ログイン時、ログアウト時や、パスワード変更変更時に状態の更新があるためコンテキストにした

### features

#### api

- page(またはhooks)で用いるapiを定義している
- `api/`ディレクトリにある汎用関数に、、`apiのパス`、`httpメソッド`、`リクエスト・レスポンスの型(JSON)`を渡し、実装している
- ※JSON形式のみ対応

#### Components(src直下)

- pageで用いるコンポーネントを定義している
- `components/`ディレクトリにあるUIに`props`を渡して実装している
- `form`などのリクエストをする要素の場合は、`layouts`に `hooks form` と `zod` を用いて実装
- `zod`は、schemaを作成し、型定義とバリエーションチェックをしている

#### constants

- テーブルのthタグなどの定数を定義(現状それくらい)

#### hooks

- `API 通信（データの取得）`を集約する
- hook は「ユースケース単位」で責務を完結させ、呼び出し側は handler をそのまま渡すだけにする
- page を持たない処理（例: マスタデータ取得）も hooks として定義する

#### utils

- そのfeatures(機能)で用いる関数
- テストのしやすさなどを考慮して、utilsにして切り出した

#### page

- 最終的な画面コンポーネント
- 状態`取得`・条件分岐・UI 構成に専念し、`hooks`からのハンドラを貰い、UIや画面遷移などの副作用を注入する
- `components` を組み合わせ、必要に応じて `hooks` や `utils` を呼び出す

### utils(src直下)

- `handleApiError` でエラーを一元管理し、適切なエラーページ（404, 403, 500）へ遷移
- `authErrorGenerate` でサーバーへリクエストしない画面もUX的に、制御する(authContextを用いる)
- `downloadBlob`　でBlobデータのダウンロード(現状はログファイルのダウンロードのみ)

## 単体テスト戦略

### 単体テスト対象

以下の汎用的・重要度の高いモジュールを単体テストでカバー：

| 対象                             | 理由                                                          |
| -------------------------------- | ------------------------------------------------------------- |
| **components/UI/**               | 汎用的なベースコンポーネントのため                            |
| **api/**                         | 汎用API関数のため                                             |
| **contexts/**                    | アプリケーション全体で使用される状態管理のため                |
| **utils/**                       | 汎用ユーティリティ関数のため                                  |
| **features/マスタデータ/hooks/** | マスタデータフェッチは重要であり、E2Eでのカバーは難しいため　 |

### 単体テスト対象外

以下は単体テストの対象外とし、他の手段でカバー：

| 対象                        | 対象外とする理由                                                     | カバー方法                           |
| --------------------------- | -------------------------------------------------------------------- | ------------------------------------ |
| **features/\*/api/**        | APIパス、HTTPメソッド、型定義のみで、汎用API関数を呼び出しているだけ | 汎用API関数のテストでカバー          |
| **features/\*/components/** | ベースコンポーネントにpropsを渡すだけのラッパー                      | ベースコンポーネントのテストでカバー |
| **pages/**, **routes/**     | ページ遷移やルーティング、ビジネスロジック          　　             | E2Eテスト（Playwright）でカバー      |
| **フォームバリデーション**  | Zodスキーマ定義内で既にテスト済み                                    | Zodライブラリのテストに依存          |

## 開発

## 開発環境のセットアップ

### 前提条件

- Docker と Docker Compose がインストールされていること
- env.sampleを元にenv.dev が設定されていること

### 起動方法

```bash
# 開発サーバー起動(詳しくはプロジェクトのREADME参照)
docker-compose -f docker-compose.dev.yml up --build -d

# Storybook起動
npm run storybook

# テスト実行
npm run test:unit          # Vitest
npm run test:e2e      # Playwright
```

## 今後の改善予定・検討事項

- **GET + Query Parameters による検索**
  - 検索条件が多いため現在は POST で検索を実装している
  - 単純な検索条件については query を用いた GET API での検索も検討(現状は1検索のみ、queryを用いている)

- **Redux を用いた状態遷移管理**
  - 当初はマスタデータ取得に Redux を使用していた
  - サーバー状態管理としては TanStack Query が適切と判断し切り替え
  - Redux による状態遷移設計自体は今後別途開発したい
