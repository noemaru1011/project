# フロントエンド構成

## 概要

このプロジェクトは React(TypeScript) を使用したフロントエンドアプリケーションです。

## 技術スタック

- Node.js(v22.22.0 (LTS))
- TypeScript

### 主要ライブラリ

| カテゴリ         | ライブラリ                                 | 用途                                                                           |
| ---------------- | ------------------------------------------ | ------------------------------------------------------------------------------ |
| **ルーティング** | React Router (`react-router-dom`)          | ページ遷移の管理                                                               |
| **状態管理**     | `useState` / `useContext` / TanStack Query | ローカル状態、グローバル状態（パスワード変更促進フラグなど）、サーバー状態管理 |
| **フォーム**     | React Hook Form + Zod                      | フォーム制御とバリデーション(sharedにスキーマ定義)                             |
| **スタイリング** | Tailwind CSS                               | ユーティリティファーストCSS                                                    |
| **デザイニング** | Figma                                      | UI・Layoutのデザイン開発                                                   |
| **テスト**       | Vitest / Playwright                        | ユニットテスト / E2Eテスト                                                     |
| **UIカタログ**   | Storybook                                  | コンポーネントの可視化・管理                                                   |
| **フォーマッタ**   | Prettier                                  |簡単なルールのみ                                                   |
| **リンター**   | ESLint                                  　　　| recommended程度                                                   |

### 状態管理の使い分け

- **useState**: コンポーネント内のローカル状態(基本的にReact Hook Formが行う)
- **useContext**: パスワード変更促進フラグ、ログインユーザーのロール管理(複数画面・UI制御)
  ※ useContext ではサーバー同期が必要な状態は管理しない
- **TanStack Query**: マスタデータの取得、データ操作（CRUD）

## ディレクトリ構成
```
src/
├─ api/
│  └─ API通信の共通処理（JSONのみ）
│
├─ assets/
│  └─ 画像などの静的ファイル
│
├─ components/
│  ├─ UI/
│  │  └─ Button / Input など（Storybook管理）
│  └─ Layouts/
│     └─ レイアウト系（Storybook管理）
│
├─ contexts/
│
├─ features/
│  └─ feature-name/
│     ├─ pages/
│     │  └─ 画面
│     ├─ components/
│     │  └─ 機能専用UI / Layoutコンポーネント
│     ├─ api
│     │  └─ src直下のapi共通処理を呼び出し、APIのパス・型・HTTPメソッド定義
│     ├─ hooks/
│     │  └─ カスタムフック
│     └─ constants/
│        └─ 定数
│
├─ pages/  ※ feature に属さない共通・例外的ページのみ
│  ├─ Home/
│  └─ Error/
│　　　　└─  components/Layouts/ エラー画面レイアウトを呼び出す
├─ routes/
│  └─ ルーティング定義
│
├─ utils/
│  ├─ handleApiError
│  ├─ authErrorGenerate
│  └─ downloadBlob
│  └─ pageGuard.tsx
│
├─ App.tsx
├─ index.css
└─ main.tsx

※環境変数はプロジェクト直下の `.env.example` を参照
```

## 設計方針

### API通信

- `api/` ディレクトリの汎用関数を使用
- 各featuresでAPIパス、HTTPメソッド、リクエストボディを指定して使用
- CSRF トークンと JWT は自動で付与
- レスポンスが不正な時も、対応できる(サーバーに繋がらない時やJSONが壊れた時など)
- **制限事項**: JSON形式レスポンスのみ対応（ZIPファイル等のバイナリダウンロードは非対応）

### コンポーネント

- UI・Layoutのデザインは`Figma`を用いて開発
- Propsを用いて、型安全に
- hooks formを用いるので、`forwardRef`を使用して、親が直接操作できるように
- `label と id`、`fieldset 、 legend` といった基本的なセマンティクスを守る
- `ARIA属性`を適切に実装
- カタログとして見れるように`Storybook`を使用

### Context

#### **auth**:
- 本プロジェクトでは、管理者アカウントと学生アカウントで利用可能なAPIおよび画面を切り分けている。たとえば学生アカウントでは、学生を新規作成する操作（＝対応するAPIの実行）は許可されない。
- ただし、新規登録画面を「開く」こと自体はサーバーへのリクエストを伴わず（APIを呼ばずに）実現できるため、権限がないユーザーでも画面に到達できてしまう可能性がある。
- そこでUXの観点から、そもそも不適切な画面へ遷移できないように、ログイン中ユーザーの情報をコンテキストで保持し、権限に応じて画面遷移を制御している。
- ログインやログアウト時など複数個所で状態の更新があるためコンテキストにした

#### **passwordUpdate**:
- ログイン時に、学生が初期パスワードのまま、もしくは変更から30日以上経過していた場合は、パスワード変更ボタンの横に!マークが出現する
- auth同様、ログイン時、ログアウト時や、パスワード変更変更時に状態の更新があるためコンテキストにした

### features

#### api
- page(またはhooks)で用いるapiを定義している
- `api/`ディレクトリにある汎用関数に、、`apiのパス`、`httpメソッド`、`リクエスト・レスポンスの型(JSON)`を渡し、実装している
- ※JSON形式のみ対応

#### components
- pageで用いるコンポーネントを定義している
- ` components/`ディレクトリにあるUIに`props`を渡して実装している
- `form`などのリクエストをする要素の場合は、`layouts`に `hooks form` と `zod` を用いて実装
- `zod`は、schemaを作成し、型定義とバリエーションチェックをしている

#### constants
- テーブルのthタグなどの定数を定義(現状それくらい)

#### hooks
- `API 通信・副作用（react-toastify / navigation / Context 更新 / cache 操作 / Contextの更新 など）`を集約する
- hook は「ユースケース単位」で責務を完結させ
- 呼び出し側は handler をそのまま渡すだけにする
- page を持たない処理（例: マスタデータ取得）も hooks として定義する

#### utils
- そのfeatures(機能)で用いる関数
- テストのしやすさなどを考慮して、utilsにして切り出した

#### page
- 最終的な画面コンポーネント
- 状態取得・条件分岐・UI 構成に専念し、
- API 通信や副作用の詳細は原則持たない
- `components` を組み合わせ、必要に応じて `hooks` や `utils` を呼び出す
- イベントハンドラは、hooks から返される関数をそのまま渡すことを基本とする


### utils
- `handleApiError` でエラーを一元管理し、適切なエラーページ（404, 403, 500）へ遷移
- `authErrorGenerate` でサーバーへリクエストしない画面もUX的に、制御する(authContextを用いる)
- `downloadBlob`　でBlobデータのダウンロード(現状はログファイルのダウンロードのみ)
- `pageGuard` で `App.tsx`内で、画面の権限制御

## 単体テスト戦略

### 単体テスト対象

以下の汎用的・重要度の高いモジュールを単体テストでカバー：

| 対象                   | 理由                                                                                      |
| ---------------------- | ----------------------------------------------------------------------------------------- |
| **components/UI/**     | 汎用的なベースコンポーネントのため                                                        |
| **api/**               | 汎用API関数のため                                                                         |
| **contexts/**          | アプリケーション全体で使用される状態管理のため                                            |
| **utils/**             | 汎用ユーティリティ関数のため                                                              |
| **features/マスタデータ/hooks/** | マスタデータフェッチは重要であり、E2Eでのカバーは難しいため　 |

### 単体テスト対象外

以下は単体テストの対象外とし、他の手段でカバー：

| 対象                        | 対象外とする理由                                                     | カバー方法                           |
| --------------------------- | -------------------------------------------------------------------- | ------------------------------------ |
| **features/\*/api/**        | APIパス、HTTPメソッド、型定義のみで、汎用API関数を呼び出しているだけ | 汎用API関数のテストでカバー          |
| **features/\*/components/** | ベースコンポーネントにpropsを渡すだけのラッパー                      | ベースコンポーネントのテストでカバー |
| **pages/**, **routes/**     | ページ遷移やルーティングロジック                                     | E2Eテスト（Playwright）でカバー      |
| **フォームバリデーション**  | Zodスキーマ定義内で既にテスト済み                                    | Zodライブラリのテストに依存          |

## 開発

## 開発環境のセットアップ

### 前提条件

- Docker と Docker Compose がインストールされていること
- env.dev が設定されていること

### 起動方法

```bash
# 開発サーバー起動(詳しくはプロジェクトのREADME参照)
docker-compose -f docker-compose.dev.yml up --build -d

# Storybook起動
npm run storybook

# テスト実行
npm run test:unit          # Vitest
npm run test:e2e      # Playwright
```

## 今後の改善予定・検討事項

- **カスタムデータ属性を用いた画面制御**
  - 現在は value / label をDBとマッピングしているのみ
  - 今後は HTML のカスタムデータ属性（data-\*）と紐付けを行い、
    hooks を用いて画面制御ロジック(イメージは、画面上での自動計算処理)などを実装してみたい

- **GET + Query Parameters による検索**
  - 検索条件が多いため現在は POST で検索を実装している
  - 単純な検索条件については query を用いた GET API での検索も検討(現状は1検索のみ、queryを用いている)

- **Redux を用いた状態遷移管理**
  - 当初はマスタデータ取得に Redux を使用していた
  - サーバー状態管理としては TanStack Query が適切と判断し切り替え
  - Redux による状態遷移設計自体は今後別途開発したい
