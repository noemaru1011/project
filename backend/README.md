# バックエンド構成

## 概要

このプロジェクトは Express を使用したバックエンドアプリケーションです。

## 技術スタック

### 主要ライブラリ

| カテゴリ                  | ライブラリ | 用途                                                                                          |
| ------------------------- | ---------- | --------------------------------------------------------------------------------------------- |
| **サーバー**              | Express    | Webアプリケーションフレームワーク                                                             |
| **データベース**          | PostgreSQL |                                                                                               |
| **ORM**                   | Prisma     | データベースアクセス・マイグレーション管理                                                    |
| **キャッシュ/セッション** | Redis      | トークン管理（JWT等のセッション情報）                                                         |
| **バリデーション**        | Zod        | サーバーサイドバリデーション                                                                  |
| **メール送信**            | Resend     | メール送信（ユーザー作成時の初期パスワード通知） ※モダンなメール送信APIを試したかったため採用 |
| **テスト**                | Vitest     | ユニットテスト                                                                                |

## ディレクトリ構成

- src
  - errors
    - FK違反、楽観的ロック、重複違反などのDB系エラー
    - ビジネスロジックエラー
    - 認証エラー（例外）を定義
  - features
    - 各機能別のモジュール
    - route
      - ルーティング定義
    - Controller
      - HTTPリクエスト/レスポンスの入り口
    - service
      - ビジネスロジック
    - repository
      - DB操作
    - utils
      - serviceを支えるヘルパー関数
    - \*.module.ts
      - 依存関係の注入
  - middleware
    - 認証 + 認可
    - ログ収集
    - サーバーサイドバリデーション（Zod）
    - CORS、Cookie等の汎用ミドルウェア
  - repositories
    - ベースリポジトリ
    - トランザクション処理を共通化（毎回定義不要）
  - types
    - サーバーサイド専用の型定義
  - utils
    - ログ収集などの汎用関数
  - app.ts
    - ルーティングとミドルウェアの定義
    - 例: `app.use(API_ROUTES.HISTORY_SEARCH, authMiddleware, requestLogger, historySearchRoutes);`
  - buildAppModules.ts
    - 依存関係の構築（routeにControllerを紐付け）
  - server.ts
    - サーバー起動処理
- Dockerfile
  - Docker設定ファイル

## アーキテクチャ

### レイヤー構成

Route →(Middleware) → Controller → Service → Repository → Database

| レイヤー       | 責務                                             |
| -------------- | ------------------------------------------------ |
| **Route**      | エンドポイント定義、ミドルウェアの適用           |
| **Middleware** | 認証・認可、ログ、バリデーション等の横断的関心事 |
| **Controller** | HTTPリクエスト/レスポンスの処理、入力の受け取り  |
| **Service**    | ビジネスロジックの実装                           |
| **Repository** | データベース操作の抽象化                         |

### 依存性注入

- 各機能の `*.module.ts` で依存関係を定義
- `buildAppModules.ts` でアプリケーション全体の依存関係を構築
- Controller、Service、Repository の疎結合を実現

### エラーハンドリング

`errors/` で定義されたカスタムエラー：

- **DB系エラー**: FK違反、楽観的ロック、重複違反
- **ビジネスロジックエラー**: ドメイン固有のエラー
- **認証エラー**: 未認証、権限不足

### トランザクション管理

- `repositories/` のベースリポジトリで共通化
- 各機能でトランザクション処理を個別に定義する必要がない

## ミドルウェアの適用例

```typescript
// app.ts
app.use(
  API_ROUTES.HISTORY_SEARCH,
  authMiddleware, // 認証・認可
  requestLogger, // リクエストログ
  historySearchRoutes, // ルーティング
);
```

ミドルウェアは以下の順序で適用：

認証・認可チェック
ログ収集
バリデーション
ビジネスロジック実行

## 認証フロー

### 1. ログイン

1. クライアントが `POST /login` でログインリクエスト
2. バックエンドがJWT + CSRFトークンを発行
3. JWTはCookieに、CSRFトークンはレスポンスボディで返却

### 2. API呼び出し

1. クライアントがCookie（JWT）とHeader（CSRFトークン）を付けてAPIリクエスト
2. バックエンドがトークンをSHA-256でハッシュ化
3. Redisのブラックリストに存在するか確認
4. ブラックリストになければ、リクエストを処理してレスポンス

### 3. ログアウト

1. クライアントが `POST /logout` でログアウトリクエスト
2. バックエンドがトークンをSHA-256でハッシュ化
3. Redisのブラックリストに追加（TTL: 1時間）
4. `200 OK` を返却

### セキュリティ対策

- **ハッシュ化**: SHA-256を使用してトークンをハッシュ化、Redisのストレージ効率を向上
- **ブラックリスト**: ログアウト時にトークンを無効化、1時間後に自動削除
- **CSRF対策**: CSRFトークンを併用

## データベースマイグレーション

### 開発環境

Docker起動時に自動で実行されます。

```bash
# docker-compose up 時に自動実行
npx prisma migrate dev  # マイグレーション適用
npx prisma db seed      # シードデータ投入
```

## シードデータ

開発環境では以下のテストデータが自動投入されます：

### マスタデータ

| マスタ                   | 説明               |
| ------------------------ | ------------------ |
| **大分類マスタ**         | 学生寮の大分類(大隊)   |
| **中分類マスタ**         | 学生寮の中分類(中隊)   |
| **小分類マスタ**         | 学生寮の小分類(小隊)   |
| **学科マスタ**           | 学科情報           |
| **ステータス区分マスタ** | 各種ステータス区分 |

### テストデータ

| データ種別         | 件数   | 説明                     |
| ------------------ | ------ | ------------------------ |
| **管理者ユーザー** | 1件    | システム管理者アカウント |
| **学生データ**     | 複数件 | テスト用の学生情報       |
| **履歴データ**     | 複数件 | テスト用の履歴情報       |

### 管理者アカウント

開発環境では以下の管理者アカウントでログインできます：

| 項目               | 値                  |
| ------------------ | ------------------- |
| **メールアドレス** | `admin@exmaple.com` |
| **パスワード**     | `admin123`          |

## 単体テスト戦略

### テストパターン

すべての単体テストは **AAAパターン**（Arrange, Act, Assert）に従って記述

### 単体テスト対象

以下の重要度の高いモジュールを単体テストでカバー：

| 対象                               | 理由                                                             |
| ---------------------------------- | ---------------------------------------------------------------- |
| **Middleware**                     | 認証・認可、バリデーション等のアプリケーション全体に影響する処理 |
| **Service**                        | ビジネスロジックの中核                                           |
| **Utils**                          | 汎用関数の動作保証                                               |
| **Repository（複雑なクエリのみ）** | 複雑な結合や集計処理の正確性を保証                               |

### 単体テスト対象外

以下は単体テストの対象外とし、他の手段でカバー：

| 対象                         | 対象外とする理由                                                   | カバー方法                                  |
| ---------------------------- | ------------------------------------------------------------------ | ------------------------------------------- |
| **Repository（単純なCRUD）** | 単純なSELECT、INSERT、UPDATE、DELETE（論理削除含む）はPrismaに依存 | Prismaの動作に依存、必要に応じてE2Eでカバー |
| **Controller**               | 薄いレイヤー（リクエスト/レスポンスの受け渡しのみ）                | E2Eテストでカバー                           |
| **Route**                    | ルーティング定義のみ                                               | E2Eテストでカバー                           |
| **Module**                   | 依存関係の定義のみ                                                 | -                                           |

## テスト実行

```bash
npm run test:unit # Vitest
```

## ログ収集

### ログの種類

- **SQLクエリ**: Prismaのクエリログ（パスワードはマスキング済み）
- **HTTPリクエスト/レスポンス**: リクエスト時間、レスポンス時間
- **エラーログ**: ビジネスロジック、DB、認証エラー等
- **プロセス監視**: `unhandledRejection`, `uncaughtException`, `SIGTERM`
- **リソース監視**: メモリ使用量、CPU使用率、イベントループ遅延（30秒ごと）

### 保存先

- 本番環境: `logs/`
- テスト環境: `log-test/`

### リソース監視の指標

| 指標           | 説明                                   |
| -------------- | -------------------------------------- |
| `rss`          | 常駐セットサイズ（物理メモリ使用量）   |
| `heapUsed`     | 使用中のヒープメモリ                   |
| `heapTotal`    | 確保されたヒープメモリ                 |
| `cpuUser`      | ユーザーCPU時間                        |
| `cpuSystem`    | システムCPU時間                        |
| `eventLoopP99` | イベントループ遅延（99パーセンタイル） |
