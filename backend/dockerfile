# ==========================================
# 1. Build Stage
# ==========================================
FROM node:22.2-slim AS builder

# Prismaのビルドに必要なシステムライブラリをインストール
RUN apt-get update -y && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 設定ファイルのコピー
COPY package.json package-lock.json tsconfig.json ./
COPY backend/package.json backend/package-lock.json backend/tsconfig.json ./backend/
COPY shared ./shared

# 依存関係のインストール
RUN npm ci

# ソースと Prisma のコピー
COPY backend/src ./backend/src
COPY backend/prisma ./backend/prisma

# Prisma Client 生成 & ビルド
WORKDIR /app/backend
RUN npx prisma generate
RUN npm run build

# 本番に不要な依存関係を削除
WORKDIR /app
RUN npm prune --production


# ==========================================
# 2. Production Stage
# ==========================================
FROM node:22.2-slim AS runner

RUN apt-get update -y && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*

WORKDIR /app
ENV NODE_ENV=production

# 依存関係をコピー
COPY --from=builder /app/node_modules ./node_modules

# ビルド済みファイルを /app 直下に展開されるようにコピー
# builder 側の dist の構造に合わせて調整してください
# もし dist/backend/src/... になっているなら、以下のようになります
COPY --from=builder /app/backend/dist ./dist
COPY --from=builder /app/backend/package.json ./package.json
COPY --from=builder /app/backend/prisma ./prisma

EXPOSE 3000

# npm run start ではなく、直接 node で起動する
# パスはエラーログにある "dist/backend/src/server.js" を指定
CMD ["node", "dist/backend/src/server.js"]