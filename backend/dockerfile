FROM node:22.21.1

WORKDIR /project

# ========== Root dependencies ==========
COPY package.json package-lock.json ./
COPY tsconfig.json ./
RUN npm ci

# ğŸ”’ Root ã®ä¾å­˜é–¢ä¿‚ã‚’ç›£æŸ»
RUN npm audit --audit-level=high

# ========== Backend dependencies ==========
WORKDIR /project/backend
COPY backend/package.json backend/package-lock.json ./
COPY backend/tsconfig.json ./
RUN npm ci

# ğŸ”’ Backend ã®ä¾å­˜é–¢ä¿‚ã‚’ç›£æŸ»
RUN npm audit --audit-level=high

# ========== Source ==========
COPY backend/src ./src
COPY backend/prisma ./prisma
RUN npx prisma generate
RUN npx prisma db seed

# ========== Shared ==========
WORKDIR /project
COPY shared ./shared

ENV TS_NODE_PROJECT=/project/backend/tsconfig.json

WORKDIR /project/backend

EXPOSE 3000
CMD ["npm", "run", "dev"]
